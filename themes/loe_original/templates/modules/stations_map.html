<style>
    #stations-map-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    #map-wrapper {
        flex: 1 1 600px;
        max-width: 100%;
    }

    #stations-map-container svg {
        width: 100%;
        height: auto;
        display: block;
    }

    #stations-map-container svg path {
        fill: #d0d0d0;
        cursor: pointer;
        transition: fill 0.2s;
    }

    #stations-map-container svg path.state-highlight {
        fill: #88BDBD;
        /* Blue highlight */
    }

    #stations-map-container svg .borders {
        stroke: #ffffff;
        fill: none;
        pointer-events: none;
    }

    #stations-list-display {
        flex: 1 1 300px;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #eee;
        min-height: 200px;
    }

    #stations-list-display h3 {
        margin-top: 0;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }

    #stations-list-display ul {
        padding-left: 20px;
    }
</style>

<div id="stations-map-container">
    <div id="map-wrapper">
        <!-- SVG Map will be inserted here or pasted below -->
        {% include "us_map.svg" ignore missing %}
    </div>
    <div id="stations-list-display">
        <h3>Select a State</h3>
        <p>Hover over a state to see available stations.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stationMap = {};
        const articleContent = document.querySelector('.article-content');

        if (articleContent) {
            const headings = articleContent.querySelectorAll('h2');
            headings.forEach(h2 => {
                const stateName = h2.textContent.trim();
                // Find the next UL
                let nextElem = h2.nextElementSibling;
                while (nextElem && nextElem.tagName !== 'UL' && nextElem.tagName !== 'H2') {
                    nextElem = nextElem.nextElementSibling;
                }

                if (nextElem && nextElem.tagName === 'UL') {
                    stationMap[stateName] = nextElem.outerHTML;
                    // Optionally hide the original list if we only want map interaction
                    // h2.style.display = 'none';
                    // nextElem.style.display = 'none';
                }
            });
        }

        const mapSvg = document.querySelector('#stations-map-container svg');
        const displayDiv = document.getElementById('stations-list-display');

        if (mapSvg) {
            // Add ID to svg if missing for CSS specificity
            mapSvg.id = 'us-map-svg';

            const paths = mapSvg.querySelectorAll('path');
            const classToStateName = {};

            // Pass 1: Find state names for classes
            paths.forEach(path => {
                const title = path.querySelector('title');
                const pathClass = path.getAttribute('class');
                if (title && pathClass) {
                    // Extract the base class (e.g. "mi" from "mi other-class") if needed,
                    // but usually it's just one class or we assume the first one is the identifier.
                    // The SVG structure seems to use single classes like "mi", "nm", etc.
                    // We'll trust the class attribute for grouping.
                    const stateName = title.textContent.trim();
                    if (!pathClass.includes('borders') && !pathClass.includes('separator')) {
                        classToStateName[pathClass] = stateName;
                    }
                }
            });

            // Pass 2: Assign data-state-name and add listeners
            paths.forEach(path => {
                const pathClass = path.getAttribute('class');
                // Use the map to get the state name, or fallback to local title if valid
                let stateName = classToStateName[pathClass];

                if (!stateName) {
                    const title = path.querySelector('title');
                    if (title) {
                        stateName = title.textContent.trim();
                    }
                }

                if (stateName && !path.classList.contains('borders') && !path.classList.contains('separator')) {
                    path.setAttribute('data-state-name', stateName);

                    path.addEventListener('mouseenter', () => {
                        const safeStateName = stateName.replace(/"/g, '\\"');
                        const stateParts = mapSvg.querySelectorAll(`path[data-state-name="${safeStateName}"]`);

                        stateParts.forEach(part => part.classList.add('state-highlight'));

                        if (stationMap[stateName]) {
                            displayDiv.innerHTML = `<h3>${stateName}</h3>${stationMap[stateName]}`;
                        } else {
                            displayDiv.innerHTML = `<h3>${stateName}</h3><p>No stations listed.</p>`;
                        }
                    });

                    path.addEventListener('mouseleave', () => {
                        const safeStateName = stateName.replace(/"/g, '\\"');
                        const stateParts = mapSvg.querySelectorAll(`path[data-state-name="${safeStateName}"]`);
                        stateParts.forEach(part => part.classList.remove('state-highlight'));
                    });
                }
            });

            // Optional: Reset on mouse leave of the whole map
            /*
            mapSvg.addEventListener('mouseleave', () => {
                displayDiv.innerHTML = '<h3>Select a State</h3><p>Hover over a state to see available stations.</p>';
            });
            */
        }
    });
</script>