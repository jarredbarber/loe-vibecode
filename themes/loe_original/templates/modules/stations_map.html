<style>
    #stations-map-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-top: 20px;
    }

    #map-wrapper {
        flex: 1 1 600px;
        max-width: 100%;
    }

    #stations-map-container svg {
        width: 100%;
        height: auto;
        display: block;
    }

    #stations-map-container svg path {
        fill: #d0d0d0;
        cursor: pointer;
        transition: fill 0.2s;
    }

    /* Highlight Active State Overlay */
    /* Target the <use> elements created in the highlight overlay group */
    #stations-map-container svg use.state_highlight {
        fill: #88BDBD !important;
        pointer-events: none;
        /* Ensure clicks pass through to the path below */
    }

    /* Legacy/Direct Path Highlighting (if needed for fallback) */
    #stations-map-container svg path.state-highlight,
    #stations-map-container svg circle.state-highlight,
    #stations-map-container svg path.state_highlight,
    #stations-map-container svg circle.state_highlight {
        fill: #88BDBD !important;
        /* Blue highlight */
    }

    #stations-map-container svg .borders {
        stroke: #ffffff;
        fill: none;
        pointer-events: none;
    }

    /* Fix for SVG artifacts: border paths like 'nm-tx' inherit fill, causing grey shapes */
    #stations-map-container svg path[class*="-"] {
        fill: none !important;
        stroke: #ffffff;
        stroke-width: 1px;
        pointer-events: none;
    }

    #stations-list-display {
        flex: 1 1 300px;
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #eee;
        min-height: 200px;
    }

    #stations-list-display h3 {
        margin-top: 0;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
    }

    #stations-list-display ul {
        padding-left: 20px;
    }
</style>

<div id="stations-map-container">
    <div id="map-wrapper">
        <!-- SVG Map will be inserted here or pasted below -->
        {% include "us_map.svg" ignore missing %}
    </div>
    <div id="stations-list-display">
        <h3>Select a State</h3>
        <p>Hover over a state to see available stations.</p>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const stationMap = {};
        const articleContent = document.querySelector('.article-content');

        if (articleContent) {
            const headings = articleContent.querySelectorAll('h2');
            headings.forEach(h2 => {
                const stateName = h2.textContent.trim();
                // Find the next UL
                let nextElem = h2.nextElementSibling;
                while (nextElem && nextElem.tagName !== 'UL' && nextElem.tagName !== 'H2') {
                    nextElem = nextElem.nextElementSibling;
                }

                if (nextElem && nextElem.tagName === 'UL') {
                    stationMap[stateName] = nextElem.outerHTML;
                    // Optionally hide the original list if we only want map interaction
                    // h2.style.display = 'none';
                    // nextElem.style.display = 'none';
                }
            });
        }

        const mapSvg = document.querySelector('#stations-map-container svg');
        const displayDiv = document.getElementById('stations-list-display');

        if (mapSvg) {
            // Add ID to svg if missing for CSS specificity
            mapSvg.id = 'us-map-svg';

            // Select both paths and circles (for DC)
            const paths = mapSvg.querySelectorAll('path, circle');
            const classToStateName = {};

            // Create highlight layer group (for z-index handling without DOM reordering)
            const highlightGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            highlightGroup.setAttribute('id', 'highlight-overlay');
            highlightGroup.style.pointerEvents = 'none'; // Critical for anti-flicker
            mapSvg.appendChild(highlightGroup);

            // Pass 1: Find state names for classes
            paths.forEach(path => {
                const title = path.querySelector('title');
                const pathClass = path.getAttribute('class');
                if (title && pathClass) {
                    const stateName = title.textContent.trim();
                    const classes = pathClass.split(/\s+/);
                    classes.forEach(cls => {
                        // Strict check: only 2-letter codes or specific ignored classes
                        if (cls && cls.length === 2 && !['st', 'bo', 'se'].includes(cls.toLowerCase())) {
                            classToStateName[cls] = stateName;
                        }
                    });
                }
            });

            // Pass 2: Assign data-state-name and add listeners
            paths.forEach(path => {
                // Find state name from classes
                let stateName = null;
                const pathClass = path.getAttribute('class');

                if (pathClass) {
                    const classes = pathClass.split(/\s+/);
                    for (const cls of classes) {
                        if (classToStateName[cls]) {
                            stateName = classToStateName[cls];
                            break;
                        }
                    }
                }

                if (!stateName) {
                    const title = path.querySelector('title');
                    if (title) {
                        stateName = title.textContent.trim();
                    }
                }

                // Exclude borders and separators explicitly
                if (stateName && pathClass && !pathClass.includes('borders') && !pathClass.includes('separator')) {

                    // Assign unique ID if missing (needed for <use> href)
                    if (!path.id) {
                        path.id = 'map-path-' + Math.random().toString(36).substr(2, 9);
                    }

                    path.setAttribute('data-state-name', stateName);

                    path.addEventListener('mouseenter', () => {
                        const safeStateName = stateName.replace(/"/g, '\\"');
                        const stateParts = mapSvg.querySelectorAll(`[data-state-name="${safeStateName}"]`);

                        // Clear previous highlights
                        while (highlightGroup.firstChild) {
                            highlightGroup.removeChild(highlightGroup.firstChild);
                        }

                        stateParts.forEach(part => {
                            // Create explicit clones (not <use>) to guarantee style override
                            // <use> shadow DOM often resists styling if the original has classes
                            const clone = part.cloneNode(true);
                            clone.removeAttribute('id'); // Avoid ID conflicts
                            clone.removeAttribute('class'); // Strip original classes to avoid interfering styles

                            // Force highlight styles directly
                            clone.style.setProperty('fill', '#88BDBD', 'important');
                            clone.style.setProperty('stroke', '#ffffff', 'important');
                            clone.style.setProperty('stroke-width', '1px', 'important');
                            clone.style.pointerEvents = 'none'; // Critical for anti-flicker
                            clone.classList.add('state_highlight'); // For good measure

                            highlightGroup.appendChild(clone);
                        });

                        if (stationMap[stateName]) {
                            displayDiv.innerHTML = `<h3>${stateName}</h3>${stationMap[stateName]}`;
                        } else {
                            displayDiv.innerHTML = `<h3>${stateName}</h3><p>No stations listed.</p>`;
                        }
                    });

                    path.addEventListener('mouseleave', () => {
                        // Clear highlights
                        while (highlightGroup.firstChild) {
                            highlightGroup.removeChild(highlightGroup.firstChild);
                        }
                    });
                }
            });
        }
    });
</script>